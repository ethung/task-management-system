# <!-- Powered by BMAD™ Core -->

# Story 1.4: Weekly Planning & Reflection System

## Status
accepted

## Story
**As a** user of the productivity application,
**I want** a comprehensive weekly planning and reflection system with prompts, intention setting, and progress tracking,
**so that** I can effectively plan my weeks, break down goals into daily "Big 3" tasks, conduct meaningful weekly reflections, and track my progress week-over-week to maintain focus and achieve my career objectives.

## Acceptance Criteria
1. Weekly planning prompts appear automatically and guide users through intention setting for the upcoming week
2. Users can break down weekly goals into daily "Big 3" priority tasks with proper scheduling
3. Weekly reflection workflow captures what went well, areas for improvement, and goals for next week
4. Progress tracking provides week-over-week insights with visual progress indicators
5. Weekly planning interface supports Markdown input for rich goal descriptions and notes
6. Weekly reflections are stored and accessible for historical review and pattern identification
7. System remembers user preferences for planning day/time and sends gentle reminders
8. Integration with existing task management system to automatically populate relevant tasks
9. Weekly reflection data can be exported for performance reviews and career development discussions
10. Mobile-responsive design ensures planning and reflection can happen on any device
11. **NEW**: Users can create/edit goals, plans, and tasks for any past or future date (not limited to current week)
12. **NEW**: System maintains comprehensive version history for all planning entities (goals, plans, tasks, reflections)
13. **NEW**: Users can undo/revert any change with a single click, accessing previous versions instantly
14. **NEW**: Users can view detailed change history and select specific versions to restore from timeline view

## Dev Notes

### Previous Story Insights
- Task management foundation from Story 1.3 provides the underlying CRUD operations and project organization needed for weekly planning
- Authentication system from Story 1.2 ensures user data security and personalized planning experiences
- Development environment from Story 1.1 includes all necessary tools for building complex React components with state management

### Data Models
Based on database schema from `docs/database-setup.md`, new models needed:

**WeeklyPlans**
- `id` - Unique identifier (cuid)
- `userId` - Owner reference (from existing Users model)
- `weekStartDate` - Monday of the week (Date)
- `weeklyGoals` - JSON array of goal objects with title, description, priority
- `intentions` - Markdown text for weekly intentions and focus areas
- `status` - DRAFT | ACTIVE | COMPLETED | ARCHIVED
- `createdAt` / `updatedAt` - Timestamps
[Source: docs/database-setup.md#database-schema]

**WeeklyReflections**
- `id` - Unique identifier (cuid)
- `userId` - Owner reference
- `weeklyPlanId` - Reference to associated weekly plan
- `weekEndDate` - Sunday of the week (Date)
- `accomplishments` - Markdown text for what went well
- `challenges` - Markdown text for areas of improvement
- `lessons` - Markdown text for key learnings
- `nextWeekGoals` - Markdown text for goals setting
- `satisfactionRating` - Integer 1-10 for week satisfaction
- `progressNotes` - Markdown text for additional progress notes
- `createdAt` / `updatedAt` - Timestamps
[Source: docs/database-setup.md#database-schema]

**BigThreeTasks** (extends existing Tasks model)
- Add `bigThreeRank` - Integer 1-3 for daily priority ranking
- Add `weeklyPlanId` - Optional reference to weekly plan
- Add `plannedDate` - Date for when task is scheduled
[Source: docs/database-setup.md#tasks]

**NEW - AuditLog** (Version Control & Change Tracking)
- `id` - Unique identifier (cuid)
- `entityType` - WEEKLY_PLAN | WEEKLY_REFLECTION | TASK | GOAL
- `entityId` - Reference to the versioned entity
- `userId` - User who made the change
- `changeType` - CREATE | UPDATE | DELETE | RESTORE
- `beforeData` - JSON snapshot of entity state before change
- `afterData` - JSON snapshot of entity state after change
- `changeDescription` - Human-readable change summary
- `timestamp` - When change occurred
- `version` - Incremental version number for the entity
- `parentVersion` - Reference to previous version (for branching/merging)
[Source: Enhanced requirements for version control and undo functionality]

**NEW - EntityVersions** (Version Storage & Retrieval)
- `id` - Unique identifier (cuid)
- `entityType` - WEEKLY_PLAN | WEEKLY_REFLECTION | TASK | GOAL
- `entityId` - Reference to the current entity
- `versionData` - Complete JSON snapshot of entity at this version
- `version` - Version number
- `createdAt` - Version creation timestamp
- `createdBy` - User who created this version
- `isActive` - Boolean flag for current active version
- `tags` - JSON array for version tagging (milestone, backup, etc.)
[Source: Enhanced requirements for temporal data access and version history]

### API Specifications
Following REST API patterns established in the project:

**Weekly Planning Endpoints:**
- `GET /api/weekly-plans` - Get user's weekly plans with pagination
- `POST /api/weekly-plans` - Create new weekly plan
- `GET /api/weekly-plans/[id]` - Get specific weekly plan
- `PUT /api/weekly-plans/[id]` - Update weekly plan
- `DELETE /api/weekly-plans/[id]` - Archive weekly plan
- `GET /api/weekly-plans/current` - Get current week's plan
- `POST /api/weekly-plans/[id]/generate-tasks` - Auto-generate daily tasks from weekly goals

**Weekly Reflection Endpoints:**
- `GET /api/weekly-reflections` - Get user's reflections with pagination
- `POST /api/weekly-reflections` - Create new reflection
- `GET /api/weekly-reflections/[id]` - Get specific reflection
- `PUT /api/weekly-reflections/[id]` - Update reflection
- `GET /api/weekly-reflections/export` - Export reflections for performance reviews

**Big Three Integration:**
- `GET /api/tasks/big-three/[date]` - Get Big 3 tasks for specific date
- `PUT /api/tasks/[id]/big-three-rank` - Set/update Big 3 ranking

**NEW - Version Control & Temporal Access:**
- `GET /api/weekly-plans/[id]/versions` - Get all versions of a weekly plan with timestamps
- `POST /api/weekly-plans/[id]/revert/[version]` - Revert weekly plan to specific version
- `GET /api/weekly-plans/date/[date]` - Get/create weekly plan for any specific date (past/future)
- `GET /api/weekly-reflections/[id]/versions` - Get all versions of a reflection
- `POST /api/weekly-reflections/[id]/revert/[version]` - Revert reflection to specific version
- `GET /api/audit-log/entity/[entityType]/[entityId]` - Get change history for specific entity
- `POST /api/undo` - Universal undo endpoint for last user action
- `GET /api/version-history/user` - Get user's recent change history across all entities
- `POST /api/entities/[entityType]/[entityId]/create-version` - Manually create version snapshot
- `GET /api/temporal/weekly-plans/[year]/[week]` - Access plans by ISO week for any year
[Source: Enhanced requirements for flexible temporal access and version control]

### Component Specifications
Following modular component architecture from project structure:

**WeeklyPlanningWizard Component:**
- Multi-step form for weekly goal setting and intention capture
- Markdown editor integration for rich text input
- Date picker for week selection
- Goal breakdown interface for creating daily tasks
- Progress from previous week's reflection integration
[Source: Component patterns from existing task management UI]

**WeeklyReflectionForm Component:**
- Structured reflection prompts with Markdown support
- Rating scale component for satisfaction scoring
- Achievement highlighting and challenge identification
- Goal setting for upcoming week with task generation
- Progress visualization showing week-over-week improvements
[Source: Form patterns from authentication and task creation]

**WeekProgressDashboard Component:**
- Visual progress indicators for weekly goal completion
- Week-over-week comparison charts
- Big 3 task completion tracking
- Reflection history timeline view
- Export functionality for career development
[Source: Dashboard patterns from project structure]

**NEW - VersionControl Component:**
- Undo/redo button with last action preview
- Version history timeline with visual diff comparison
- One-click revert functionality for any previous version
- Change tracking with user attribution and timestamps
- Conflict resolution interface for simultaneous edits
[Source: Enhanced requirements for version control capabilities]

**NEW - TemporalNavigator Component:**
- Date picker for accessing any past or future week
- Quick navigation to specific years/months for long-term planning
- Calendar view showing weeks with existing plans vs empty weeks
- Time-travel mode for viewing historical planning states
- Future planning workflow for advance goal setting
[Source: Enhanced requirements for temporal data access]

**NEW - VersionHistoryPanel Component:**
- Side panel showing chronological change history
- Visual indicators for different types of changes (create, edit, delete)
- User avatar and timestamp for each change
- Expandable diff view showing before/after states
- Tagging system for important milestones and versions
[Source: Enhanced requirements for detailed change tracking]

### File Locations
Based on project structure from `docs/architecture/`:

**Components:**
- `components/weekly-planning/WeeklyPlanningWizard.tsx`
- `components/weekly-planning/WeeklyReflectionForm.tsx`
- `components/weekly-planning/WeekProgressDashboard.tsx`
- `components/weekly-planning/BigThreeSelector.tsx`
- `components/ui/markdown-editor.tsx` (enhanced from existing)
- `components/version-control/VersionControl.tsx` (NEW)
- `components/version-control/TemporalNavigator.tsx` (NEW)
- `components/version-control/VersionHistoryPanel.tsx` (NEW)
- `components/version-control/UndoRedoButton.tsx` (NEW)
- `components/ui/diff-viewer.tsx` (NEW)

**API Routes:**
- `app/api/weekly-plans/route.ts`
- `app/api/weekly-plans/[id]/route.ts`
- `app/api/weekly-plans/current/route.ts`
- `app/api/weekly-reflections/route.ts`
- `app/api/weekly-reflections/[id]/route.ts`
- `app/api/weekly-plans/date/[date]/route.ts` (NEW - temporal access)
- `app/api/weekly-plans/[id]/versions/route.ts` (NEW - version history)
- `app/api/weekly-plans/[id]/revert/[version]/route.ts` (NEW - version revert)
- `app/api/audit-log/route.ts` (NEW - change tracking)
- `app/api/undo/route.ts` (NEW - universal undo)
- `app/api/version-history/user/route.ts` (NEW - user change history)
- `app/api/temporal/weekly-plans/[year]/[week]/route.ts` (NEW - ISO week access)

**Database Utilities:**
- `lib/db/weekly-plans.ts` - CRUD operations for weekly plans
- `lib/db/weekly-reflections.ts` - CRUD operations for reflections
- `lib/db/big-three.ts` - Big Three task management utilities
- `lib/db/audit-log.ts` (NEW - change tracking and audit trail utilities)
- `lib/db/entity-versions.ts` (NEW - version storage and retrieval utilities)
- `lib/db/temporal-access.ts` (NEW - past/future date access utilities)
- `lib/versioning/version-manager.ts` (NEW - version control logic and diff generation)
- `lib/versioning/undo-redo.ts` (NEW - undo/redo state management)

**Pages:**
- `app/planning/page.tsx` - Main weekly planning interface
- `app/planning/reflect/page.tsx` - Weekly reflection interface
- `app/planning/history/page.tsx` - Planning and reflection history
- `app/planning/[year]/[week]/page.tsx` (NEW - temporal access to specific weeks)
- `app/planning/versions/[entityType]/[entityId]/page.tsx` (NEW - version history viewer)
[Source: docs/architecture/ - established file organization patterns]

### Testing Requirements
Following testing strategy patterns:

**Unit Tests:**
- Weekly plan creation, update, and validation logic
- Reflection form submission and data processing
- Big Three task ranking and scheduling algorithms
- Progress calculation and week-over-week comparison utilities
- Version control: audit log creation and version storage
- Temporal access: date validation and past/future plan retrieval
- Undo/redo: state management and action reversal logic
- Diff generation: before/after state comparison algorithms

**Integration Tests:**
- Weekly planning workflow from goal setting to task generation
- Reflection submission and historical data retrieval
- Big Three task integration with existing task management
- Export functionality for career development materials
- Version control: end-to-end versioning workflow (create → edit → revert)
- Temporal navigation: accessing and editing plans across different time periods
- Audit trail: complete change tracking from UI actions to database storage
- Cross-entity version consistency during complex operations

**E2E Tests:**
- Complete weekly planning cycle (plan → execute → reflect)
- Cross-device planning and reflection experience
- Historical data access and pattern identification
- Version control user flows: undo last action, revert to previous version, view change history
- Temporal planning: create future plans, edit past plans, navigate between time periods
- Performance testing: version storage efficiency with large change histories
[Source: Testing patterns from existing project setup + enhanced version control requirements]

### Technical Constraints
- Weekly plans must integrate seamlessly with existing task management system without breaking current functionality
- Reflection data must be exportable in multiple formats (PDF, CSV, JSON) for performance reviews
- Mobile-responsive design required for on-the-go planning and reflection
- Data retention policy needed for long-term career tracking (minimum 2 years)
- Performance optimization required for users with extensive planning history
- **NEW**: Version storage must be efficient to handle extensive change histories without performance degradation
- **NEW**: Temporal data access must support efficient querying across years of planning data
- **NEW**: Undo operations must complete within 200ms for responsive user experience
- **NEW**: Database schema for version control must maintain referential integrity during complex operations
- **NEW**: Audit logging must capture all changes without impacting primary operation performance
- **NEW**: Version comparison and diff generation must handle large planning documents efficiently
[Source: Project requirements and enhanced scalability considerations for version control]

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Extension & Version Control** (AC: 1, 8, 11, 12)
  - [ ] Create Prisma schema for WeeklyPlans model with validation rules
  - [ ] Create Prisma schema for WeeklyReflections model with rating constraints
  - [ ] Extend existing Tasks model with BigThree ranking and weekly plan references
  - [ ] **NEW**: Create Prisma schema for AuditLog model with comprehensive change tracking
  - [ ] **NEW**: Create Prisma schema for EntityVersions model with snapshot storage
  - [ ] Create database migration for new tables and foreign key relationships
  - [ ] **NEW**: Implement database triggers for automatic audit log generation
  - [ ] Create seed data for testing weekly planning and reflection workflows
  - [ ] Add database utilities in `lib/db/weekly-plans.ts` for CRUD operations
  - [ ] Add database utilities in `lib/db/weekly-reflections.ts` for reflection management
  - [ ] **NEW**: Add database utilities in `lib/db/audit-log.ts` for change tracking
  - [ ] **NEW**: Add database utilities in `lib/db/entity-versions.ts` for version storage

- [ ] **Task 2: Version Control & Audit Trail System** (AC: 12, 13, 14)
  - [ ] **NEW**: Implement data versioning system in `lib/versioning/version-manager.ts`
  - [ ] **NEW**: Create automatic version snapshot creation on entity changes
  - [ ] **NEW**: Build diff generation algorithms for before/after comparison
  - [ ] **NEW**: Implement version restoration logic with data integrity checks
  - [ ] **NEW**: Create undo/redo state management system in `lib/versioning/undo-redo.ts`
  - [ ] **NEW**: Build conflict resolution system for simultaneous edits
  - [ ] **NEW**: Add version tagging system for milestone marking
  - [ ] **NEW**: Implement performance optimization for large version histories

- [ ] **Task 3: Temporal Data Access System** (AC: 11, 14)
  - [ ] **NEW**: Create temporal data access utilities in `lib/db/temporal-access.ts`
  - [ ] **NEW**: Implement past/future date validation and plan retrieval
  - [ ] **NEW**: Build ISO week-based data access for yearly navigation
  - [ ] **NEW**: Create calendar view data aggregation for planning overview
  - [ ] **NEW**: Implement efficient querying for historical planning data
  - [ ] **NEW**: Add time-travel mode for viewing historical planning states
  - [ ] **NEW**: Create future planning workflow with advance goal setting

- [ ] **Task 4: Enhanced API Endpoints** (AC: 8, 9, 11, 12, 13)
  - [ ] Implement `GET /api/weekly-plans` with pagination and filtering by date range
  - [ ] Implement `POST /api/weekly-plans` with goal validation and automatic task generation
  - [ ] Implement `GET /api/weekly-plans/current` for active week retrieval
  - [ ] Implement `PUT /api/weekly-plans/[id]` with goal update and task synchronization
  - [ ] Implement `POST /api/weekly-reflections` with satisfaction rating validation
  - [ ] Implement `GET /api/weekly-reflections/export` with multiple format support
  - [ ] Add Big Three task ranking endpoints for daily priority management
  - [ ] **NEW**: Implement `GET /api/weekly-plans/date/[date]` for temporal access
  - [ ] **NEW**: Implement version control endpoints for plans and reflections
  - [ ] **NEW**: Create `POST /api/undo` universal undo endpoint
  - [ ] **NEW**: Build audit log and version history retrieval endpoints
  - [ ] **NEW**: Implement `GET /api/temporal/weekly-plans/[year]/[week]` for ISO access
  - [ ] Create API integration tests for all weekly planning and version control endpoints

- [ ] **Task 5: Version Control UI Components** (AC: 13, 14)
  - [ ] **NEW**: Create VersionControl component with undo/redo buttons
  - [ ] **NEW**: Build VersionHistoryPanel with chronological change display
  - [ ] **NEW**: Implement visual diff viewer for before/after comparison
  - [ ] **NEW**: Create one-click revert functionality with confirmation dialogs
  - [ ] **NEW**: Add user attribution and timestamp display for changes
  - [ ] **NEW**: Build conflict resolution interface for edit collisions
  - [ ] **NEW**: Implement version tagging UI for milestone management
  - [ ] **NEW**: Create responsive design for mobile version control access

- [ ] **Task 6: Temporal Navigation Interface** (AC: 11)
  - [ ] **NEW**: Create TemporalNavigator component with flexible date selection
  - [ ] **NEW**: Build calendar view showing weeks with existing vs empty plans
  - [ ] **NEW**: Implement quick navigation for years/months/weeks
  - [ ] **NEW**: Add time-travel mode toggle for historical viewing
  - [ ] **NEW**: Create future planning workflow interface
  - [ ] **NEW**: Build visual indicators for plan existence across time periods
  - [ ] **NEW**: Implement keyboard shortcuts for temporal navigation

- [ ] **Task 7: Enhanced Weekly Planning Interface** (AC: 1, 2, 5, 11)
  - [ ] Create WeeklyPlanningWizard component with step-by-step goal setting
  - [ ] Implement Markdown editor integration for rich goal descriptions
  - [ ] Build weekly goal breakdown interface for generating daily tasks
  - [ ] Create Big Three task selector with drag-and-drop priority ranking
  - [ ] Add date picker for flexible week selection and planning ahead
  - [ ] **NEW**: Integrate temporal navigation for past/future planning
  - [ ] **NEW**: Add version control integration with undo/redo functionality
  - [ ] Implement goal validation and saving with optimistic UI updates
  - [ ] Add integration with existing task management for seamless workflow
  - [ ] Create responsive design for mobile and tablet planning experience

- [ ] **Task 8: Enhanced Weekly Reflection System** (AC: 3, 6, 9, 12, 13)
  - [ ] Create WeeklyReflectionForm component with structured prompts
  - [ ] Implement satisfaction rating scale with visual feedback
  - [ ] Build accomplishment and challenge capture with Markdown support
  - [ ] Create next week goal setting with automatic plan generation
  - [ ] Add reflection history view for pattern identification and growth tracking
  - [ ] **NEW**: Integrate version control for reflection editing and restoration
  - [ ] **NEW**: Add change tracking display for reflection modifications
  - [ ] Implement export functionality for performance reviews (PDF, CSV formats)
  - [ ] Create reflection reminder system with user preference settings
  - [ ] Add reflection analytics for personal insights and progress measurement

- [ ] **Task 9: Enhanced Progress Tracking Dashboard** (AC: 4, 10, 14)
  - [ ] Create WeekProgressDashboard with visual progress indicators
  - [ ] Implement week-over-week comparison charts using data visualization library
  - [ ] Build Big 3 completion tracking with streak visualization
  - [ ] Create reflection timeline view for historical pattern analysis
  - [ ] **NEW**: Add version history timeline integration
  - [ ] **NEW**: Build change frequency and editing pattern analytics
  - [ ] Add goal achievement metrics and success rate calculations
  - [ ] Implement mobile-responsive dashboard design for cross-device access
  - [ ] Create progress export functionality for career development discussions
  - [ ] Add personalized insights based on planning and reflection data

- [ ] **Task 10: Integration and Enhanced User Experience** (AC: 7, 8, 10, 11, 12, 13, 14)
  - [ ] Integrate weekly planning with existing task management system
  - [ ] Create user preference settings for planning reminders and scheduling
  - [ ] Implement gentle reminder system for weekly planning and reflection
  - [ ] **NEW**: Add user preferences for version control behavior (auto-save frequency, undo levels)
  - [ ] **NEW**: Create onboarding flow including version control and temporal navigation features
  - [ ] Create help documentation and tooltips for planning best practices
  - [ ] **NEW**: Add help documentation for version control and temporal planning features
  - [ ] Implement keyboard shortcuts for efficient planning and reflection
  - [ ] **NEW**: Add keyboard shortcuts for undo/redo and temporal navigation
  - [ ] Add accessibility features for screen readers and keyboard navigation
  - [ ] **NEW**: Ensure version control interfaces are fully accessible
  - [ ] Create comprehensive testing suite for all weekly planning workflows
  - [ ] **NEW**: Create comprehensive testing suite for version control and temporal access

## Project Structure Notes
- Weekly planning components follow the established modular architecture pattern
- Database extensions align with existing Prisma schema conventions
- API routes maintain consistency with current REST API structure
- Integration points with existing task management preserve current functionality
- Mobile-responsive design follows project's cross-device accessibility standards

## Dev Agent Record

### Implementation Notes
*This section will be populated during development by the Dev Agent*

### Completion Status
*Tasks will be marked complete as implementation progresses*

### Debug Log References
*Links to debug log entries will be added during development*

### Technical Decisions
*Architectural decisions and implementation choices will be documented here*

### Challenges and Solutions
*Development challenges and their solutions will be recorded for future reference*

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-23 | 2.0 | **MAJOR ENHANCEMENT**: Added critical user feedback requirements including flexible creation/modification for any date, comprehensive version control system with undo/redo functionality, and temporal data access. Added 4 new acceptance criteria (AC 11-14), new database models (AuditLog, EntityVersions), enhanced API endpoints for version control and temporal access, new UI components for version management, and comprehensive testing requirements for the enhanced functionality. | SM Agent (Bob) |
| Initial | 1.0 | Original weekly planning and reflection system story | SM Agent |
